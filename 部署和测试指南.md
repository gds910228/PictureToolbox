# AI功能部署和测试指南

## 📋 前置条件检查

在开始部署前，请确认：

- ✅ 已开通微信小程序云开发（基础版即可）
- ✅ 已获取云环境ID：`cloud1-1gk79pjqd5e1ed35`
- ✅ 已配置腾讯云API密钥到 `cloudfunctions/analyzeImage/config.json`
- ✅ 已完成云函数代码更新

## 🚀 部署步骤

### 第1步：编译小程序（2分钟）

1. 打开**微信开发者工具**
2. 打开项目 `PictureToolbox`
3. 点击顶部 **"编译"** 按钮
4. 等待编译完成（应该在右下角显示"编译完成"）

### 第2步：部署云函数（5分钟）

#### 方式A：通过微信开发者工具部署（推荐）

1. 在左侧文件树中找到 `cloudfunctions/analyzeImage` 文件夹
2. **右键点击** `analyzeImage` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传和部署完成（右下角会显示进度）
5. 成功后会提示：**"云函数上传并部署成功"**

#### 方式B：通过云开发控制台部署

1. 点击顶部工具栏的 **"云开发"** 按钮
2. 在左侧菜单选择 **"云函数"**
3. 点击 **"新建"** 或找到 `analyzeImage` 函数
4. 如果是新建：
   - 函数名称：`analyzeImage`
   - 运行环境：Node.js 16
5. 上传代码文件（zip格式）
6. 点击 **"部署"**

### 第3步：配置云开发环境（1分钟）

在云函数部署前，需要在小程序代码中配置云环境ID：

1. 打开 `pages/compress/compress.js` 文件
2. 找到 `onLoad()` 方法（约第26-35行）
3. 更新云开发初始化代码：

```javascript
onLoad() {
  wx.setNavigationBarTitle({
    title: '图片压缩'
  });

  // ✅ 启用云开发
  this.setData({
    cloudEnabled: true
  });

  // ✅ 初始化云开发
  if (wx.cloud) {
    wx.cloud.init({
      env: 'cloud1-1gk79pjqd5e1ed35', // ← 你的云环境ID
      traceUser: true
    });
  }
},
```

4. 保存文件（Ctrl+S）

### 第4步：重新编译（1分钟）

配置完成后，重新编译小程序：
1. 点击 **"编译"** 按钮
2. 等待编译完成

## ✅ 测试AI功能

### 测试步骤

1. **进入压缩页面**
   - 在模拟器或真机中
   - 点击 **"图片压缩"** 工具卡片
   - 进入压缩页面

2. **选择测试图片**
   - 点击 **"选择图片"** 按钮
   - 从相册选择一张图片
   - 建议：选择人物照片、风景照片、文字文档各测试一次

3. **观察AI分析过程**
   - 图片上传后，应该显示：**"AI分析中..."**
   - 加载动画或进度提示
   - 约1-3秒后显示分析结果

4. **验证AI分析结果**
   - 应该看到紫色的AI分析卡片
   - 显示图片类型（portrait/landscape/text等）
   - 显示推荐质量百分比
   - 显示推荐理由和优化建议
   - 点击 **"应用AI建议"** 按钮
   - 质量滑块应该自动移动到推荐位置

### 预期结果

#### 成功场景（真实API）

```
AI分析结果：
- 图片类型：portrait（人物照）
- 置信度：85%
- 推荐质量：85%
- 策略：quality-priority（质量优先）
- 理由：检测到人物照片，保持较高质量以保留面部细节
- 建议：建议质量85-90%，避免过度压缩导致面部模糊
```

#### 降级场景（API未配置或失败）

如果API调用失败，会自动降级到模拟实现：

```
AI分析结果：
- 图片类型：（随机：portrait/landscape/text/product）
- 推荐质量：80-90之间
- 包含合理的建议文本
```

**注意**：降级场景下仍然能正常使用，只是不是真实AI分析结果。

### 查看云函数日志

查看详细运行日志，确认是否使用了真实API：

1. 点击顶部 **"云开发"** 按钮
2. 左侧菜单 → **"云函数"**
3. 找到 `analyzeImage` 函数
4. 点击 **"日志"**
5. 查看最近的日志记录

**真实API的日志特征**：
```
开始分析图片 { fileID: 'cloud://...', hasBase64: false }
获取到临时图片URL: https://...
调用混元API分析图片...
混元API返回: {"Response":{"Choices":[...],...}}
AI分析结果: { imageType: 'portrait', confidence: 0.85, ... }
```

**模拟实现的日志特征**：
```
开始分析图片 { fileID: 'cloud://...', hasBase64: false }
获取到临时图片URL: https://...
调用混元API分析图片...
未配置API密钥，使用模拟实现
或
使用占位符密钥，使用模拟实现
```

## 🐛 故障排查

### 问题1：云函数部署失败

**症状**：右键部署后提示错误

**可能原因**：
- 网络连接问题
- 云开发环境未开通
- 依赖包安装失败

**解决方法**：
1. 检查网络连接
2. 确认云开发已开通（点击"云开发"按钮）
3. 重试部署
4. 或使用云开发控制台手动部署

### 问题2：AI分析功能不显示

**症状**：选择图片后没有AI分析提示

**可能原因**：
- `cloudEnabled` 未设置为 `true`
- 云开发环境ID配置错误
- 云函数未部署

**解决方法**：
1. 检查 `pages/compress/compress.js` 第29行：`cloudEnabled: true`
2. 检查云环境ID是否正确：`cloud1-1gk79pjqd5e1ed35`
3. 确认云函数 `analyzeImage` 已成功部署
4. 在控制台查看错误信息

### 问题3：提示"云开发环境未配置"

**症状**：控制台显示"云开发环境未配置，已自动切换到普通压缩模式"

**可能原因**：
- `wx.cloud.init()` 未正确调用
- 云环境ID配置错误
- 云开发环境未创建

**解决方法**：
1. 确认已开通云开发（点击"云开发"按钮 → "开通"）
2. 检查 `env: 'cloud1-1gk79pjqd5e1ed35'` 是否正确
3. 重新编译小程序
4. 在云开发控制台确认环境存在

### 问题4：API调用失败，使用模拟实现

**症状**：日志显示"调用混元API失败"或"使用模拟实现"

**可能原因**：
- API密钥配置错误
- 网络问题
- API服务异常
- 请求参数错误

**解决方法**：
1. 检查 `cloudfunctions/analyzeImage/config.json` 中的密钥是否正确
2. 确认SecretId和SecretKey没有多余的空格或换行
3. 在腾讯云控制台确认密钥有效
4. 查看详细错误日志，确定具体原因
5. 暂时使用模拟实现（功能仍然可用）

### 问题5：真实API返回错误

**症状**：日志显示API调用但返回错误

**常见错误和解决方法**：

#### AuthFailure（签名错误）
```
错误：AuthFailure.SignatureFailure
原因：密钥错误或参数错误
解决：
1. 确认SecretId和SecretKey正确
2. 检查是否有复制错误（多余的空格）
3. 尝试重新生成密钥
```

#### RequestLimitExceeded（请求超限）
```
错误：RequestLimitExceeded
原因：超过API调用频率限制
解决：
1. 稍后重试
2. 检查是否被滥用
3. 考虑升级套餐
```

#### ResourceUnavailable（资源不可用）
```
错误：ResourceUnavailable
原因：服务异常或维护中
解决：
1. 稍后重试
2. 查看腾讯云公告
3. 使用模拟实现降级
```

## 📊 性能优化建议

### API调用优化

1. **缓存分析结果**
   - 相同图片不重复分析
   - 使用云存储fileID作为缓存key
   - 缓存有效期：1小时

2. **异步处理**
   - AI分析不阻塞压缩流程
   - 用户可以先手动压缩，AI建议完成后提示

3. **批量分析**
   - 如果用户上传多张图片
   - 可以批量调用API
   - 降低调用成本

### 成本控制

1. **监控用量**
   - 在云开发控制台查看调用次数
   - 在腾讯云控制台查看API费用
   - 设置费用告警阈值

2. **优化Prompt**
   - 简化提示词，减少Token消耗
   - 当前Prompt约300个中文字符
   - 可以进一步精简到100字以内

3. **降级策略**
   - API失败时使用模拟实现
   - 用户体验不受影响
   - 成本可控

## 🎯 测试清单

完成部署后，按以下清单测试：

### 基础功能测试

- [ ] 图片选择功能正常
- [ ] 图片预览显示正常
- [ ] 质量调节滑块可用
- [ ] 压缩按钮可点击
- [ ] 压缩后图片可保存

### AI功能测试

- [ ] 选择图片后显示"AI分析中..."
- [ ] 显示紫色AI分析卡片
- [ ] 显示图片类型和推荐质量
- [ ] 点击"应用AI建议"后滑块移动
- [ ] 云函数日志显示API调用

### 降级测试

- [ ] 断网情况下仍可使用基础压缩
- [ ] API失败时自动降级到模拟实现
- [ ] 错误提示友好清晰

### 边缘情况测试

- [ ] 选择超大图片（>10MB）
- [ ] 选择极小图片（<10KB）
- [ ] 快速连续选择多张图片
- [ ] 在AI分析过程中取消操作

## 📝 部署确认

部署完成后，请确认以下信息：

```
✅ 云开发环境：cloud1-1gk79pjqd5e1ed35
✅ 云函数状态：已部署
✅ API密钥配置：已完成
✅ 云开发初始化：已完成
✅ AI功能测试：已通过
```

## 🎉 部署成功！

如果所有测试都通过，恭喜你成功部署了AI智能压缩功能！

### 后续优化方向

1. **真实AI调优**
   - 根据实际效果优化Prompt
   - 调整不同类型图片的压缩策略
   - 收集用户反馈改进算法

2. **性能优化**
   - 添加结果缓存
   - 优化云函数冷启动时间
   - 减少API调用成本

3. **功能增强**
   - 支持更多图片类型识别
   - 添加智能裁剪建议
   - 支持批量图片分析

4. **用户体验**
   - 添加分析进度动画
   - 优化错误提示文案
   - 添加分析历史记录

---

**部署日期**：2026-01-22
**部署状态**：✅ 配置完成，待部署测试
**下一步**：按上述步骤部署云函数并测试

如有问题，请参考"故障排查"部分或查看相关文档。
